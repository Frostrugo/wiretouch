class DataManager {
  // TODO: use less global variables
  Serial myPort;
  String fakeData;
  
  DataManager(Serial port) {
    if (port == null) {
      // show the hand
      fakeData = "1.5887075891744145,1.2186412647695153,2.2589850454811002,0.9091110883068549,0.9090934312121018,0.9302563258621618,0.9589614379784551,0.9143724572286275,0.9094344798651165,1.0000649759685283,1.0,1.0000013871705193,0.9302378642806916,0.9091325261867662,0.9144903200175628,0.9090985149042553,0.9203667894160125,0.930232580150783,0.8218550484279393,0.909413913515407,0.9090915396198248,1.166166589185854,1.0436913914502302,0.9989031310389923,1.1018210829698676,1.0238052460236047,1.077689031921072,1.070630702681095,1.0962234256473873,1.0755204557640816,1.1366179686001998,1.0000002494000497,1.0115363488639666,1.0772161150489519,1.0354683814686658,1.0,1.0533337080321714,1.0604653496473464,1.1385649454399585,1.0460397330590583,1.0091389119787935,1.035167357096771,1.0444179586364304,0.9979532952983262,1.0054854109238345,0.9999713349045392,1.0005454949351298,1.017023551054377,1.0979189882459637,1.0655396616650434,1.0760213644706393,1.1013216386059275,1.09220213801542,1.0008964014656834,1.0726002459593194,1.1230127218248886,1.0767634298172681,1.0,1.0313780029380144,1.0090421221510926,1.0462656126142162,1.0099834381963253,1.0488452379428626,1.0278602747699301,1.0033357448107851,1.0000039982355766,1.0265771216935657,1.0072931920529482,1.0002643040833854,0.9964291628495039,1.0289540258530592,1.0629653763125864,1.1029575170328545,1.0746898554185715,1.0554404012483962,0.9989843844953308,1.0920669116062354,1.0501999451723911,1.0969512050443688,1.0,1.121330013812046,1.004917087198093,1.0772446113300524,1.0513309355541116,1.044652726901206,1.0048941874358164,1.0027288457755976,0.9999880050904256,1.0127409895901152,1.0000079974610774,1.0003875161278675,1.0457771586611193,1.0619165475533106,1.042610161685869,1.1269062265075922,1.0290622928424038,1.0451500276648515,0.9979529248861583,1.084599075491987,1.037611102386071,1.0289209002083268,1.0,0.9985486493028471,1.0463769349742356,1.0350206227049352,1.0893759510991223,1.0863663467155262,1.0546798856861193,1.0823787106656175,1.0000319869375234,1.0174346916385015,1.0157174247368697,0.9996991703058326,1.080391949516573,1.0620941157850357,1.0308299460855863,1.1473965304981237,1.0126796684247685,0.9933798603722532,1.0000639754338507,1.0714071677374029,1.0675128873586623,1.0356752354762715,1.0,1.0345920444102137,1.0062330777458381,1.0386514081849452,1.0346318817460312,1.0882182931449738,1.082295227938516,1.0573148207874115,1.0007363382723633,0.9889637170990079,1.0115207815584222,0.9974504447500516,1.0284384417930437,1.0649833215559894,1.107259288799592,1.1195217012772227,1.0289438739226913,1.0992949280899704,0.9999981258431363,1.0034820263330186,1.0428950493610778,1.0970585712613998,1.0,1.008757893965517,1.0181990575001998,1.0725079669249487,1.0862154068125238,1.0593946126603089,1.0473862545203667,1.0093426082572368,1.0002081991075502,1.0002852213515667,1.0426140829696073,0.9991046017957148,1.0269334571254696,1.0778295193186023,1.0676601918603745,1.0975404312346095,1.0652577206444522,1.1782616091472515,1.0000019991083977,1.060360145330077,1.0563056287063337,1.0458594454878016,1.0,1.104652002460232,1.0339386738570104,1.075632333969962,1.0323065900078263,1.0806156613318274,1.0328829913999156,1.026877664591901,0.9989844629941745,0.9781051626865267,1.0417551211086948,0.9980126164457321,0.9879738040983459,1.0961603383000669,1.1048120409291935,1.1116422348652142,1.0379268904504393,1.151086567361466,0.9994879594516491,0.9801741331916091,1.0250061275407412,1.051512401090819,1.0,1.0624153196586341,1.017648917015117,1.03653897308674,1.041194524400462,1.0545838285100022,1.0347801296390424,1.0209537908812243,0.9992321476756496,1.0114134496431437,1.0160813312201697,0.9990422420189494,1.014333366194744,1.04579553485817,1.032866094100012,1.114450489596176,1.0526534198980673,1.1637723883064497,1.0000000155569955,1.1160459530657596,1.0422962348615281,1.0330793846850759,1.0,1.012695570503332,1.0257569827814674,1.026639323929479,1.0407122206117345,1.0400295739537142,1.0437343573467235,1.0702392338722848,1.0000018820053618,1.0012238204837778,1.0053522723060972,1.0005205577742116,1.0273045522216349,1.0782315821000215,1.0598628980326419,1.111695550997318,1.1299970662850016,1.116126992440708,1.0000159930909995,1.043870971752352,1.0767118790341457,1.0448139767185063,1.0,1.0426458268004548,1.0164506456916613,1.0518638553521362,1.0249698059691954,1.0648902800174571,1.0435376095300695,1.0255174240537193,0.9979534160975958,1.036494114880135,1.0065075403880879,1.0002599634119962,1.0605100006394022,1.0871037820301068,1.0777375714919657,1.1743569995856005,1.0751776106834208,1.0973196209738718,1.0000020147264634,1.054316789557788,1.0375720962695711,1.0472352590167628,1.0,0.9993759366736167,1.053521370479716,1.086175838705117,1.1058389969115432,1.1381979796648352,1.049017684369334,1.0414085300692957,1.0001282091196193,1.002627082482067,1.0437155277605092,0.9989924060190198,1.0434599550270482,1.117190962355178,1.1074981136473279,1.1061260434482052,1.1153914587054372,1.1487704374277035,1.0000082463880158,1.0677421579355106,1.1128768631913288,1.0973368049780146,1.0,1.049914245373631,1.0786501193078635,1.0502657436574432,1.0457330244313128,1.184245743942472,1.0868608620681244,1.1110711498098291,0.9995514659052122,1.0185473360584225,1.0012847418322492,0.9974109053898381,1.0313470102899194,1.0243047861731078,1.0790346293503639,1.0642865692310095,1.025563448170903,1.1098065676344608,0.999872140105851,1.0235569504776065,1.042030883893817,1.060966966371856,1.0,1.0678676236229498,1.0239314082066484,1.045478692540063,1.0263465318392218,1.107093122493859,1.052643894505901,1.004132009242643,1.0000003745900983,1.0027152714431962,1.0147382281315795,1.0011596401554321,1.032547047809006,1.0973864801729947,1.05905923712481,1.1265700772293412,1.114081577972206,1.1286890552764761,1.0001639690603639,1.1095921187695932,1.1204268586998363,1.0500181860157956,1.0,1.0826529199990307,1.0313689567577737,1.0178420911724013,1.066214042582204,1.0505656568944484,1.040430206322216,1.0414305964977773,1.000000178143013,1.0211309717716088,1.0309133537003774,1.0357133861047612,1.025389720591638,1.1577861282190864,1.096745904194034,1.081834156528771,1.083941706653121,1.2072700015918545,1.0010245901639345,1.0324064775695998,1.0540923912821092,1.0933235481666488,1.0,1.0700492338354182,1.0939574929905234,1.052080019904704,1.0772944482128732,1.0759232024305838,1.0731186803940904,1.107318004389515,0.9999960494234119,1.0194481115793463,1.0136704480390792,1.0796046757321447,1.0145355070654491,1.0961981355160222,1.1289736482799766,1.0643351235416953,1.0716505528492521,1.1324915875019268,0.9979529191631621,1.110472553265955,1.0695763192509469,1.0675617558683979,1.000002774332981,1.0713628094167338,1.0396440459467196,1.0489708828482154,1.0513778520573351,1.0593469919333476,1.114746734476944,1.1668289266910457,0.9989926849082909,0.973117474839649,1.0416999146302663,1.0261477147358002,0.9752684818351437,1.0612270972398117,1.0485775189597766,1.1007153617795806,1.118767574849819,1.174861669258832,1.0010236176538634,1.0492434106974484,1.1064125596234002,0.9958472013925248,1.0,1.0678465626060027,1.0323062489175736,1.0372117253380682,1.0216629693064607,1.0762485339594865,1.080457283772744,1.0235480343017935,1.0000007469808518,1.0096190516351364,1.0464830935622231,1.0615076160428352,1.0462322385278584,1.0412359720862177,1.0935081756228076,1.1353435443405964,1.0538572347544948,1.0874593651638185,1.0000000000000004,1.0322092910202265,1.0320820760947491,1.1101398896432466,1.0,1.0992662539958382,1.0847490858690896,1.158406783653042,1.0839213679317883,1.064621068906712,1.0957014433390042,1.1628713538003834,1.0001017229886928,1.0522659922281272,1.040578184157427,1.086793666864344,1.0367100309188237,1.0679989706474953,1.09578186965115,1.1721983303089942,1.063269338083693,1.11266853003773,1.0000001249437438,0.9999740054630352,1.0237236409934205,1.1154021438444566,1.0,1.0612377390498087,1.0338010585399826,1.0315043178836734,1.0300673799166211,1.0999193109011192,1.1024629341091778,1.1051943379510891,1.000023989843089,1.0225084293468116,1.0299031291435212,1.1333902818119759,1.04794660254849,1.0933008388970364,1.0389250383335429,1.1288137877021938,1.0852415279146455,1.1125764524595152,0.9999999999466329,1.0805510032576982,1.0709190719151904,1.0309008343469457,1.0,1.0431944274037745,1.1001593252321695,1.0631286893163783,1.061397411430372,1.1102853776721637,1.080090854046024,1.118698687996952,0.9979530417516842,1.0267579136256948,1.0155340880285393,1.093883010456887,1.0425529156959765,1.0911570512859567,1.1236575710601013,1.143481449117074,1.0577494163125227,1.1393782963746004,1.0000000002488574,1.002112516259996,1.0295059741449388,1.0751515779493455,1.0,1.0651021372400742,1.0639708748793364,1.0943462455567976,1.0823557295650192,1.096191629536987,1.04633758687074,1.1214905528354626,1.001070634642486,1.0495138086336466,1.0167196224281565,1.0594193284572502,1.0008842115233105,1.069364595091579,1.0919649523465322,1.1145751464858642,1.0609141448126482,1.1373897883168524,1.0000000155112396,1.0513798838112831,1.0719014923225343,1.085541297496674,1.000000001354651,1.07446074017866,1.01838751047234,1.0594302384175573,1.048379078001117,1.0687025102637597,1.0307190203537837,1.066805958064056,0.9991842582246596,1.0029503955745573,1.007921706393596,1.0673040590065361,1.0848232945041043,1.0312313231391617,1.0187516898893343,1.0579793582794101,1.0796675793407358,1.078664810352072,1.0002559508574094,1.1020155389084982,1.1334950723303951,1.0716665868600728,1.0,1.096114810362597,1.0432086907570297,0.9993716993126479,1.0540167939217555,1.029548181563819,1.0875057181005214,1.094163947153306,0.9999999999999998,0.9954136111600774,1.0215690611005905,1.0083044542597115,1.0186830860530456,1.099883938853822,1.1411041749147997,1.086582098562232,1.066258782564419,1.1226932493214155,1.0000000312360222,1.1909288115406709,1.0131673131515655,1.0551060740407572,1.0,0.9991592182799358,1.0018941792937623,1.1256661923278168,1.1006921703597954,1.134200011239759,1.0282260139823567,1.0451184307604655,1.0054395615839877,0.9847467383701805,1.0098240365933298,1.1064245601224407,1.0462461169369315,0.9996939835068407,1.0125870605716318,1.0940834402556479,1.0477728379096225,1.0563813723271989,0.9976976247694188,1.1594819539585444,1.0439070393420256,1.0490654989123454,1.0,0.9843601033974418,1.0375596182250455,1.0195301965484387,1.029127256921932,1.0940146966282622,1.0639076571531967,1.0610004629613243,1.0000080275067291,1.0457432956382837,0.9726436037632313,1.012219351046773,1.0432537328819191,1.0302238918827928,1.0285634146467213,1.1510300211640345,1.0298151006848575,1.0464160665075468,0.9999999918403376,1.1130788436070582,1.027949140954681,0.991690547458101,1.0,1.0544795526811148,1.0559538251437486,1.144381090830693,1.1225900284122587,1.1026742543579053,1.022405595988128,1.065693037061743,1.001058505156492,1.104712863341506,1.031321506771798,1.006024630991729,1.055719678445527,1.1522994817678718,1.0949511429348233,1.1097853933901867,1.060947487457125,1.1014681043949812,0.9998721995735456,0.9864690462468272,1.0829776357787404,1.0611771152207583,1.0,1.0178439336757679,1.0351665782095691,1.1435860252528935,1.1114803102011694,1.147299265895197,1.08397405422253,1.0336595290734698,0.9991372473661094,0.9707023643753668,1.0000329863106812,0.999228964354968,0.9981881187761519,1.1177529215168858,1.0551268563756033,1.0354301757520274,1.042122332325617,1.087619388298098,1.0000000000000075,0.9592244629362456,1.0567247272190674,1.0369360818429483,1.0,1.0140762460562092,1.0497463697041107,1.0155020408398638,1.0130339229830123,1.0945161704833222,1.0614639120101401,1.1223418968388021,0.9989794619439621,0.9750719025448986,1.0000639598248726,1.0000083870390697,1.0161123559891625,1.1936842448225673,1.0637731446467726,1.0354009600511587,0.9800524966711723,1.045712842417037,1.0000002503761902,0.9509391889621188,1.0295023475487872,1.0402044401450021,1.0,1.0583192329569584,1.0265364348257913,1.130007008363108,1.099032866337215,1.0613510544419378,1.0447382428915881,1.064205607439669,1.0010342978148574,1.1005691767847274,0.9982083907799597,0.9998720736855636,1.0002719522050671,1.2599559907567348,1.0000022568871039,1.0001289565434708,1.037436830515794,1.0384604122795371,1.0000004988001039,0.9959397739947854,0.9974699874659659,1.0000002499491187,0.9999993064191489,0.9979491763910268,0.9989768319885788,1.0000320066722663,1.0015376730800045,0.9999659548884018,0.9999975030203123,1.0010317879039616,1.0000639754373069,0.9819259835620133,1.0000039972558101,1.000856365035199,1.0000039992314236,1.1386117137603766,0.9999780178387749,0.9994874946816096,1.1203678840134348,1.0086504807828163,0.9989924341719948,1.0155906370537335,0.998210316636669,1.000000015602662,0.9999999916075137,0.9994805028961922,0.9991072293212748,0.9979431071239567,1.000516027021406,1.000255919121224,0.9979529170175295,0.9989139288434582,0.9989764741484289,";      averageSignalCounter=0;
      this.parseFakeData();
      textInformation = helpText;
    }
    else {
      println(Serial.list());
      this.myPort = port;
      this.myPort.clear(); // // do we need this? (cargo cult programming)
      if (bReadBinary) {
        // TODO: better encapsulation
        serBuffer = new byte[2 * horizontalWires * verticalWires];
        this.myPort.buffer(2 * horizontalWires * verticalWires);
      }
      else {
        this.myPort.bufferUntil(32); // buffer everything until ASCII whitespace char triggers serialEvent()
      }
      textInformation = "starting to calibrate";
    }
  }
  
  int sb2ub(byte p) {
    return p < 0 ? 256+p : p;
  }
  
  void consumeSerialBuffer(Serial p) {
    p.readBytes(serBuffer);
    if (!bDebug) {
      for (int i = 0; i < verticalWires; i++) {
        for(int j = 0; j < horizontalWires; j++) {
           int sigPos = i*horizontalWires + j;
           int sig = ((sb2ub(serBuffer[2*sigPos])) << 8) | (sb2ub(serBuffer[2*sigPos+1]));
           if (averageSignalCounter > 0) {
             // calculate the average signal strength for every crosspoint
             crosspoints[i][j].accumulateAvgSig(sig);
           } else {
              crosspoints[i][j].setSignalStrength(sig);
           }
        }
      }
      calibrationFeedback();
    }
  }
  
  // TODO: this code needs some serious refactoring...
  void calibrationFeedback() {
    if (averageSignalCounter > 0) {
      averageSignalCounter--;
      if (averageSignalCounter != 0) {
        textInformation = "calibrating: "+averageSignalCounter;
      }
      else {
        textInformation = helpText;
      }
    }    
  }
  
  void parseData(String myString) {
    if (!bDebug) {
      myString = trim(myString);
      int data[] = int(split(myString,','));
      int k = 0;
      for (int i = 0; i < verticalWires; i++) {
        for(int j = 0; j < horizontalWires; j++) {
          if (averageSignalCounter > 0) {
            // calculate the average signal strength for every crosspoint
            // TODO: optimize
            crosspoints[i][j].accumulateAvgSig(data[k]);  
          } else {
            crosspoints[i][j].setSignalStrength(data[k]);
          }
          k++;
        }
      }
      calibrationFeedback();
    }
  }
  
  void parseFakeData() {
    fakeData = trim(fakeData);
    float data[] = float(split(fakeData,','));
    int k = 0;
    for (int i = 0; i < verticalWires; i++) {
      for(int j = 0; j < horizontalWires; j++) {
        crosspoints[i][j].signalStrength = data[k];
        k++;
      }
    } 
  }
  
  void printData() {
     println("measured signals:");
     String myString = "";
     for (int i = 0; i < verticalWires; i++) {
        for(int j = 0; j < horizontalWires; j++) {
          myString = myString+(int) crosspoints[i][j].measuredSignal+",";
        }
     }
     println(myString);
     println("calculated signal strength:");
     myString = "";
     for (int i = 0; i < verticalWires; i++) {
        for(int j = 0; j < horizontalWires; j++) {
          myString = myString+crosspoints[i][j].signalStrength+",";
        }
     }
     println(myString);
  }
}
